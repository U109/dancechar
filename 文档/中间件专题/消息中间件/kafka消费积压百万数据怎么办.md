                                  高频面试题：kafka消费积压百万数据怎么办
一、背景
某一天下午三点业务高峰期，突然收到系统告警，告警信息如下：
【告警分析通知】
告警时间：2022-10-28 18:07:23
目标名称：dance-member-service|prd
告警信息：Consumer.unprocessed.topic_integral >= 1000000, 最近5分钟内发生了3次告警, 采集值: 1085546.00, 提示: 数据积压
阈值类型：实例对象阈值
阈值ID：2702043
系统编码：dance-member-service
主运维：张三
主机IP：dance-member-service|prd
对象名称：topic_integral
原因分析：
（1）积压情况采集时间为：2022-10-28 18:08:18
（2）当前积压总量为：1252965，各分区积压的情况为：[50064, 51419, 52267, 49878, 56292, 55009, 53044, 52353, 60411, 42106, 50910, 55667, 58484, 50856, 51362, 52295, 54226, 48455, 59074, 48229, 58528, 43421, 49530, 49085]
（3）消费该主题的模块为：["dance-member-service"]
（4）kafka分区数为：24，消费节点数为：24
（5）kafka消费速率和写入速率无明显变化
（6）5分钟内主题平均每分钟写入速率如下:当前 419718.0，昨天 366523.0 ,对比昨天增长14.51%
（7）5分钟内平均每分钟消费速率如下:当前 348716.0，昨天 370522.0，,对比昨天降低5.89%，当前积压 1252965，消费速率已低于写入速率，积压量持续增长，请人工介入处理
（8）dump原始文件：****
    dump分析文件：****

二、问题排查
从这个告警消息可以看出，我们dance-member-service模块消费kafka对应的topic: topic_integral消息出现大量积压，导致消息积压的原因常见的
有两种：
1、生产消息过快
2、消费速率过慢
一般我们可以检查消费端日志，是否有大量报错，另外通过监控系统的dump文件，查看耗时比较久的线程，有针对性优化代码：
比如上面的报警后面发现，采用hutool组件的JSONUtil.toList()方法，这个方法在高并发下性能非常差;

三、解决方案
消费端： 
1）应用消费节点 < kafka partition分区数，可以扩应用消费节点，否则，扩应用消费节点没用（应急：优先扩节点）
例如：dance-member-service应用节点：24个，broker分区数：16，扩应用节点是否有用？答案：没用
     dance-member-service应用节点：12个，broker分区数：16，扩应用节点是否有用？答案：有用，扩4个节点，消费能力明显增强
2）优化消费端代码
.  自动提交改为手动提交
.  单条消费消息改为批量消费消息，数据单条入库改为批量入库
.  消费逻辑涉及DB操作，第一时间检查是否有慢SQL，通过explain分析是否可以通过加索引解决（大表要考虑是否会锁表，尽可能低峰期操作）

broker端：
1）kafka partition分区数 < 应用消费节点，可以扩broker分区数，否则，扩broker分区数没用（应急：优先扩节点）
例如：dance-member-service应用节点：12个，broker分区数：16，扩broker分区数是否有用？答案：没用
     dance-member-service应用节点：24个，broker分区数：16，扩broker分区数是否有用？答案：有用，有8个应用节点处于空闲状态，扩8个节点，消费能力明显增强

生产端：
1）针对生产端采用动态配置开关降级，关闭MQ生产（系统不能快速扩容）
2）消费端消息没有积压后，通过消息补偿程序对业务消息补偿，同时消费端需要支持幂等

注意：双十一大促或者节假日做活动抢购，这个时候生产端的消息一定会大大增加，很容易就会消息积压。我们平时要做好链路压测，
     尽可能优化消费端代码，提高消费速率。同时准备大促前的相关预案：
     1）支持动态扩容  2）配置开关动态关闭生产端   3）配置开关动态关闭消费端 4）生产端支持消息补偿 5）消费端支持消息幂等

四、代码演示
整体框架：
spring cloud alibaba + nacos +  mybatis-plus + spring-kafka
实现步骤：
1、集成spring-kafka
2、批量发送消息(提升发送端性能)
3、批量消费（提高消费端性能）









